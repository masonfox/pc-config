#!/usr/bin/env bash
#
# dev — helper script to launch a tmux development workspace for a project.
#
# What it does:
#   - Let’s you pick (or pass) a project directory under ~/git.
#   - Opens a new (or attaches to existing) tmux session named after the project.
#   - In that session it:
#       • Opens an editor (vim) in the project root
#       • Opens a window running “opencode” in the project root (if configured)
#       • Opens a window running “lazygit” for Git navigation
#       • Opens a split terminal window running a dev server (via “npm run dev”),
#         plus a second pane for commands — all rooted in the project directory
#
# How to use:
#   1. Place this script somewhere in your PATH and make it executable (chmod +x).
#   2. Call it with an argument: `dev my-project-name` — it will try to match exactly or partially a directory under ~/git.
#   3. Or call without arguments: `dev` — it will pop up a fuzzy finder (fzf) to select a project.
#   4. If a tmux session for that project exists, it attaches you to it; otherwise it creates a fresh session with all windows/panes configured.
#
# Assumptions / prerequisites:
#   - You keep your projects under ~/git (or adjust BASE_DIR)
#   - You have tmux, fzf, vim (or your editor), lazygit, and dev-server tooling (e.g. npm) installed.
#   - For workflows relying on “opencode” or “npm run dev” those commands must be valid in the project root.

BASE_DIR="$HOME/git"

# If user passed a project name argument
if [ -n "$1" ]; then
  ARG="$1"

  # 1. Try exact match (case-insensitive)
  PROJECT_DIR=$(find "$BASE_DIR" \
    -maxdepth 1 -mindepth 1 -type d \
    -iname "$ARG" -print -quit)

  # 2. If no exact match, try partial match (case-insensitive)
  if [ -z "$PROJECT_DIR" ]; then
    PROJECT_DIR=$(find "$BASE_DIR" \
      -maxdepth 1 -mindepth 1 -type d |
      grep -i "$ARG" |
      head -n 1)
  fi

  # 3. If STILL no match, fall back to fzf
  if [ -z "$PROJECT_DIR" ]; then
    PROJECT_DIR=$(find "$BASE_DIR" \
      -maxdepth 1 -mindepth 1 -type d |
      fzf --query="$ARG" --prompt="Select project: ")
  fi
else
  # No argument → use fzf selector
  PROJECT_DIR=$(find "$BASE_DIR" \
    -maxdepth 1 -mindepth 1 -type d |
    fzf --prompt="Select project: ")
fi

# If still empty somehow, bail
[ -z "$PROJECT_DIR" ] && exit 0

SESSION=$(basename "$PROJECT_DIR")

# If session exists → attach
if tmux has-session -t "$SESSION" 2>/dev/null; then
  tmux attach -t "$SESSION"
  exit 0
fi

# Create new session
tmux new-session -d -s "$SESSION" -c "$PROJECT_DIR" -n editor

# Open vim on directory
tmux send-keys -t "$SESSION:0" "vim ." C-m

# Open opencode
tmux new-window -t "$SESSION" -n opencode -c "$PROJECT_DIR"
tmux send-keys -t "$SESSION:1" "opencode" C-m

# Open lazygit
tmux new-window -t "$SESSION" -n git -c "$PROJECT_DIR"
tmux send-keys -t "$SESSION:2" "lazygit" C-m

# Create a combined terminal window with two panes
tmux new-window -t "$SESSION" -n terminal -c "$PROJECT_DIR"

# Left pane → run dev server
tmux send-keys -t "$SESSION:3.0" "npm run dev" C-m

# Split vertically for right pane (empty)
tmux split-window -h -t "$SESSION:3" -c "$PROJECT_DIR"

tmux select-window -t "$SESSION:0"
tmux attach -t "$SESSION"
